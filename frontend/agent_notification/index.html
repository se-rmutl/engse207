<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <!-- <link rel="stylesheet" href="/assets/css/frontend.css"> -->
    <!-- <title>Agent Notification</title> -->
    <link type="text/css" rel="stylesheet" href="./assets/css/bootstrap.css" media="screen,projection" />
    <link rel="stylesheet" href="./assets/css/style.css" media="screen" charset="utf-8" />

    <!----------- Code here -------------->

    <script language="JavaScript">
        const {
            ipcRenderer,
            remote
        } = require("electron");

        const $ = require("jquery");
        const Timer = require("easytimer.js").Timer;
        const timer = new Timer();

        var AgentCode;
        var agentStatusID;
        var callTotal = 0;
        var agentData;

        var CallID;

        //--Dev Server------------------------------
        var APIServer = "https://192.168.56.1:8443/api/v1";
        var WebSecketServer = "ws://192.168.56.1:3071";

        //--Staging Server------------------------------
        //var APIServer = "https://192.168.56.106:8443/api/v1";
        //var WebSecketServer = "ws://192.168.56.106:3071";

        var ConcurrentCall = [];
        var connectSocket = false;
        var IsLogin = 0;
        var wsChecks = "false";

        var c;
        let ws;

        let checked;

        //----------------------------------

        /*
                $(function () {
                    console.log("ready!");
        
                    $("#buttonCall").hide();
                    $("#buttonDisConnect").hide();
                    $("#buttonConnect").show();
                    $("#nodata").hide();
                    //$("#errMessage").show();
                    $("#agent").focus();
                    //alert(localStorage.getItem("switch_104_02"));
        
                    //--- Running Chrome x64 only -----   
        
                    if (localStorage.getItem("agent") != "") {
        
                        console.log("Saved Agent Code: "+localStorage.getItem("agent"));
                        $("#agent").val(localStorage.getItem("agent"));
                        checkInput('on');
                        //document.getElementById("agent").val(localStorage.getItem("agent"));
                    }
                });
        */

        function CallOnescreen(operationType, phone_number) {
            //console.log("---- CallOnescreen ----");
            //console.log(" OperationType: " + phone_number);
            //console.log(" Call to: " + phone_number);
            //console.log(" Agent Code: " + agent_code);

            ipcRenderer.send("callonescreen", {
                operationType: operationType,
                callParameter: "call",
                phoneNumber: phone_number,
                //x64Chrome: $('#switch_104_02').is(':checked'),
                x64Chrome: true,
                AgentCode: $("#agent").val(),
                callId: '',
            });

        }


        function checkInput(status) {
            if ($("#agent").val() == "") {

                //alert("Please enter Agent Code");
                $("#connectTime")
                    .empty()
                    .append("Please enter Agent Code !!");

                $("#agent").focus();
            } else {
                AgentCode = $("#agent").val();

                $.ajax({
                    url: APIServer +
                        "/getOnlineAgentByAgentCode?agentcode=" +
                        AgentCode,
                    headers: {
                        'Authorization': 'Bearer 1aaZ!ARgAQGuQzp00D5D000000.mOv2jmhXkfIsjgywpCIh7.HZpc6vED1LCbc90DTaVDJwdNqbTW5r4uZicv8AFfkOE1ialqnR8UN5.wnAgh090h'
                    },
                    timeout: 15000,
                    success: function (response) {
                        console.log(response);
                        console.log('response.error:' + response.error);
                        if (response.error == false) {
                            if ((response.data.IsLogin == 1) && (response.data.AgentStatus != 9)) {
                                wsChecks = "true";
                                console.log("new: " + wsChecks);
                                //$("#errMessage").hide();

                                firstLogin(response.data);
                                $("#nodata").show();
                                $("#display").hide();
                                $("reports").show();
                                $("#buttonDisConnect").show();
                                $("#buttonCall").show();
                                IsLogin = 1;
                                //////websocketConnect(status);
                                // return wsChecks;
                                console.log("checkInput status: " + response.data.AgentStatus);
                                statusDisplay(response.data.AgentStatus);

                                $("#ConnectionStatus").empty().append("Connected");

                                console.log(" Agent Code  -> filled");
                                localStorage.setItem("agent", $("#agent").val())
                                console.log(localStorage.getItem("agent"));

                            }
                            else {
                                console.log("[" + response.data.agent_code + "] Agent not loging");
                                $("#connectTime").empty().append("[" + response.data.agent_code + "] Agent not loging").show();
                                wsChecks = false;
                            }

                        } else {
                            console.log('---- ERROR ------');
                            console.log(response);

                            //$("#statusLabel").empty().append(response.errMessage);                            
                            $("#connectTime").empty().append(response.errMessage);

                            wsChecks = false;
                            // return exit();
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        console.log('ERROR: net::ERR_INTERNET_DISCONNECTED');
                        //$("#connectTime").empty().append("ERR_INTERNET_DISCONNECTED");
                        //$('#connectTime').empty().removeClass().addClass('badge bg-danger').append('ERR_INTERNET_DISCONNECTED');
                        $('#connectTime').empty().append('ERROR: INTERNET DISCONNECTED');
                    }
                });

                console.log(wsChecks);

            }
        }

        function firstLogin(d) {
            // connectSocket = true;

            setLoginTime();

            $("#status")
                .removeClass()
                .addClass("badge bg-success")
                .empty()
                .append("Connected");

            // $('#statusLabel').empty().removeClass().addClass('badge bg-success').append('Available');

            counterTimer();

            console.log("d.AgentStatus: " + d.AgentStatus);

            statusDisplay(d.AgentStatus);

            ipcRenderer.on("getcallid", (e, call_id) => {
                console.log("Call id:", call_id);
                CallID = call_id;
                //this.isConnected = true;
            });

        }

        function statusDisplay(status) {
            let statusLabel;
            switch (status) {
                case "1":
                    statusLabel = "Available";
                    $("#icon").attr("src", "./assets/icon/avaliable.png");
                    $("#statusLabel")
                        .empty()
                        .removeClass()
                        .addClass("badge bg-info")
                        .append(statusLabel);

                    break;
                case "2":
                    statusLabel = "Active";
                    $("#icon").attr("src", "./assets/icon/talking.png");
                    $("#statusLabel")
                        .empty()
                        .removeClass()
                        .addClass("badge bg-primary")
                        .append(statusLabel);

                    break;
                case "3":
                    statusLabel = "Wrap";
                    $("#icon").attr("src", "./assets/icon/wrap.png");
                    $("#statusLabel")
                        .empty()
                        .removeClass()
                        .addClass("badge bg-warning")
                        .append(statusLabel);

                    break;
                case "4":
                    statusLabel = "Not Ready";
                    $("#icon").attr("src", "./assets/icon/noready.png");
                    $("#statusLabel")
                        .empty()
                        .removeClass()
                        .addClass("badge bg-danger")
                        .append(statusLabel);

                    break;

                default:
                    statusLabel = "N/A";
                    $("#icon").attr("src", "./assets/icon/na.png");

                    $("#statusLabel")
                        .empty()
                        .removeClass()
                        .addClass("badge bg-dark")
                        .append(statusLabel);
                    break;
            }
        }

        function counterTimer() {
            timer.stop();
            timer.reset();

            if (connectSocket != "false") {
                timer.start();
                timer.addEventListener("secondsUpdated", function (e) {
                    $("#basicUsage")
                        .empty()
                        .removeClass()
                        .addClass("badge bg-dark")
                        .append(timer.getTimeValues().toString());

                    //console.log(connectSocket)
                });
            }
        }

        function setLoginTime() {
            var d = new Date();

            var month = d.getMonth() + 1;
            var day = d.getDate();
            var hour = d.getHours();
            var minute = d.getMinutes();
            var sec = d.getSeconds();

            var output =
                d.getFullYear() +
                "-" +
                (month < 10 ? "0" : "") +
                month +
                "-" +
                (day < 10 ? "0" : "") +
                day +
                " " +
                (hour < 10 ? "0" : "") +
                hour +
                ":" +
                (minute < 10 ? "0" : "") +
                minute +
                ":" +
                (sec < 10 ? "0" : "") +
                sec;

            //$("#icon").attr("src", "./assets/icon/na.png");
            $("#connectTime")
                .empty()
                .append("[" + AgentCode + "] Starts at: " + output);

        }

        function logoutFromAPI() {
            console.log("-- Agent Logout --");
            timer.stop();
            timer.reset();
            $("#buttonCall").hide();
            $("#nodata").hide();
            $("#basicUsage").hide();
            // ws = new WebSocket("ws://" + WebSecketServer + "/?agentcode=" + AgentCode);
            //// ws.close();

            connectSocket = false;
            $("#AgentCode").empty().append("No Data");
            $("#agent").show();
            $("#status")
                .removeClass()
                .addClass("badge bg-warning")
                .empty()
                .append("Disconnected");

            $("#buttonDisConnect").hide();
            $("#buttonConnect").show();
            $("#icon").attr("src", "./assets/icon/disconnect.png");
            $("#connectTime").empty().append("Information");
            $("#statusLabel").empty();
            $("#reports").empty();
            $("#statusLabel")
                .empty()
                .removeClass()
                .addClass("badge bg-dark")
                .append("N/A");
            IsLogin = 0;
            $('#display').show()
            $("#agent").val('')
            $("#agent").focus();

            $("#errMessage").empty();

            // $("#ConnectionStatus").empty().append("Disconnected");
            $("#ConnectionStatus").empty().removeClass().addClass('badge bg-danger').append("Disconnected");


            console.log('Socket is connected');
            console.log(" Agent Code  -> Set empty");
            localStorage.setItem("agent", "")
            console.log(localStorage.getItem("agent"));

        }



    </script>
    <!------------------------------------>

</head>

<body data-window="main">

    <div class="warper">

        <div class="row">
            <div class="col-12">
                <table class="table table-sm fs-6">
                    <tr>
                        <div class="pt-2 pl-2 pr-2">
                    <tr>
                        <td class="text-white">
                            <span class="text-white" id="connectTime">Information</span>
                        </td>
                    </tr>
                    <tr>
                        <td class="text-white">
                            <span class="text-blue badge bg-danger" id="ConnectionStatus">Disconnected</span>
                        </td>
                    </tr>
                    <tr>
                    </tr>
            </div>
            </tr>
            </table>
        </div>

        <div class="col-12">
            <table class="table table-sm fs-6">
                <tr>
                    <div class="row">
                        <div class="col-sm-12 text-center ">
                            <button id="buttonCall" class="btn btn-primary btn-sm shadow btn-block mt-2" disable
                                onclick="CallOnescreen(1,'0000')">
                                Pop-up Chrome
                            </button>
                            <button id="buttonDisConnect" class="btn btn-danger btn-sm shadow btn-block mt-2"
                                onclick="logoutFromAPI()">
                                Disconnect
                            </button>
                        </div>
                    </div>
                </tr>
            </table>
        </div>

        <div id="display">
            <div class="row">
                <div class="col-12">
                    <div class="input-group mb-1">
                        <input type="text" class="form-control form-control-sm" id="agent"
                            placeholder="Enter Agent Code" />
                        <button id="buttonConnect" class="btn btn-warning btn-sm btn-block shadow"
                            onclick="checkInput('on')">
                            Connect
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-12 text-center pt-2">

        </div>
    </div>
    </div>

    <script>
        // You can also require other files to run in this process
        // require('./renderer.js')
    </script>
</body>

</html>